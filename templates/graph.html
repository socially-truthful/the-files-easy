<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOJ Epstein Files - Connection Graph</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { overflow: hidden; }
        #graph { width: 100%; height: calc(100vh - 60px); background: radial-gradient(circle at center, #1a1f2e 0%, #0f1219 100%); }
        .node { cursor: grab; }
        .node:active { cursor: grabbing; }
        .node:hover circle { filter: brightness(1.3) drop-shadow(0 0 8px currentColor); }
        .node.dragging circle { filter: brightness(1.5) drop-shadow(0 0 12px currentColor); }
        .node.highlighted circle { stroke: #fbbf24; stroke-width: 3; }
        .link { stroke-opacity: 0.4; transition: stroke-opacity 0.2s; }
        .link.highlighted { stroke-opacity: 1; stroke: #fbbf24; }
        .node-label { pointer-events: none; font-size: 10px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .tooltip {
            position: absolute;
            background: rgba(17, 24, 39, 0.98);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 12px;
            pointer-events: none;
            z-index: 100;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .zoom-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(31, 41, 55, 0.9);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 h-[60px] flex items-center px-4">
        <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-4">
                <a href="/" class="text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <h1 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="git-branch" class="w-6 h-6 text-purple-400"></i>
                    Topic Connection Graph
                </h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-sm text-gray-400">
                    <span id="nodeCount">0</span> topics · <span id="edgeCount">0</span> connections
                </div>
                <div class="flex items-center gap-2">
                    <input type="text" id="searchNode" placeholder="Search entities..." 
                           class="px-3 py-1.5 bg-gray-700 border border-gray-600 rounded-lg text-sm text-white placeholder-gray-400 w-40 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button onclick="zoomIn()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" title="Zoom In">
                        <i data-lucide="zoom-in" class="w-4 h-4"></i>
                    </button>
                    <button onclick="zoomOut()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" title="Zoom Out">
                        <i data-lucide="zoom-out" class="w-4 h-4"></i>
                    </button>
                    <button onclick="fitToScreen()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" title="Fit to Screen">
                        <i data-lucide="maximize-2" class="w-4 h-4"></i>
                    </button>
                    <button onclick="resetZoom()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" title="Reset View">
                        <i data-lucide="home" class="w-4 h-4"></i>
                    </button>
                    <a href="/gallery" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors flex items-center gap-2 text-sm ml-2">
                        <i data-lucide="image" class="w-4 h-4 text-pink-400"></i>
                        Gallery
                    </a>
                    <a href="/chat" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2 text-sm">
                        <i data-lucide="bot" class="w-4 h-4"></i>
                        Ask AI
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Graph Container -->
    <div id="graph"></div>
    
    <!-- Tooltip -->
    <div id="tooltip" class="tooltip hidden"></div>
    
    <!-- Zoom Indicator -->
    <div id="zoomLevel" class="zoom-indicator">100%</div>

    <!-- Legend -->
    <div class="fixed bottom-4 left-4 bg-gray-800/90 border border-gray-700 rounded-lg p-4 text-sm">
        <div class="font-semibold mb-2 flex items-center gap-2">
            <i data-lucide="info" class="w-4 h-4"></i>
            Legend
        </div>
        <div class="space-y-1 text-gray-400">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                <span>Node size = document count</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-8 h-0.5 bg-gray-500"></div>
                <span>Line thickness = shared documents</span>
            </div>
        </div>
        <div class="mt-3 pt-3 border-t border-gray-700 text-gray-500 text-xs">
            Drag nodes · Scroll to zoom · Click for details
        </div>
    </div>

    <script>
        lucide.createIcons();

        // Graph state
        let svg, g, simulation, zoom;
        let nodes = [], links = [];

        // Colors for nodes based on topic
        const colorScale = d3.scaleOrdinal()
            .domain(['flight', 'financial', 'legal', 'victim', 'investigation', 'correspondence', 'property', 'associates', 'media', 'medical', 'travel', 'maxwell', 'prison', 'fbi', 'witness', 'court'])
            .range(['#3b82f6', '#22c55e', '#a855f7', '#ef4444', '#eab308', '#06b6d4', '#f97316', '#ec4899', '#6366f1', '#10b981', '#0ea5e9', '#f43f5e', '#6b7280', '#2563eb', '#f59e0b', '#8b5cf6']);

        function getNodeColor(topic) {
            const t = topic.toLowerCase();
            for (const key of colorScale.domain()) {
                if (t.includes(key)) return colorScale(key);
            }
            return '#6b7280';
        }

        async function init() {
            const width = window.innerWidth;
            const height = window.innerHeight - 60;

            // Create SVG
            svg = d3.select('#graph')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create zoom behavior
            zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                    document.getElementById('zoomLevel').textContent = Math.round(event.transform.k * 100) + '%';
                });

            svg.call(zoom);
            
            // Double-click to zoom in on area
            svg.on('dblclick.zoom', null);
            svg.on('dblclick', (event) => {
                const [x, y] = d3.pointer(event);
                svg.transition().duration(500).call(
                    zoom.transform,
                    d3.zoomIdentity.translate(width/2, height/2).scale(2).translate(-x, -y)
                );
            });

            // Create container group
            g = svg.append('g');

            // Load data
            try {
                const res = await fetch('/api/graph');
                const data = await res.json();
                
                nodes = data.nodes;
                links = data.edges;

                document.getElementById('nodeCount').textContent = nodes.length;
                document.getElementById('edgeCount').textContent = links.length;

                renderGraph(width, height);
            } catch (e) {
                console.error('Failed to load graph:', e);
            }
        }

        function renderGraph(width, height) {
            // Create force simulation
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100).strength(d => d.strength * 0.5))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => d.size + 10));

            // Create links
            const link = g.append('g')
                .attr('class', 'links')
                .selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('stroke', '#4b5563')
                .attr('stroke-width', d => Math.max(1, d.weight / 2));

            // Create node groups
            const node = g.append('g')
                .attr('class', 'nodes')
                .selectAll('g')
                .data(nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Add circles to nodes
            node.append('circle')
                .attr('r', d => d.size)
                .attr('fill', d => getNodeColor(d.id))
                .attr('stroke', '#1f2937')
                .attr('stroke-width', 2)
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip)
                .on('click', (event, d) => {
                    window.location.href = `/?topic=${d.id}`;
                });

            // Add labels to nodes
            node.append('text')
                .attr('class', 'node-label')
                .attr('dy', d => d.size + 14)
                .attr('text-anchor', 'middle')
                .attr('fill', '#9ca3af')
                .text(d => d.label);

            // Update positions on tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            
            // Find connections
            const connections = links.filter(l => 
                l.source.id === d.id || l.target.id === d.id
            ).map(l => ({
                topic: l.source.id === d.id ? l.target.label : l.source.label,
                count: l.weight
            })).sort((a, b) => b.count - a.count).slice(0, 5);

            tooltip.innerHTML = `
                <div class="font-bold text-white mb-1">${d.label}</div>
                <div class="text-gray-400 text-sm mb-2">${d.count} documents</div>
                ${connections.length ? `
                    <div class="border-t border-gray-700 pt-2 mt-2">
                        <div class="text-xs text-gray-500 mb-1">Top connections:</div>
                        ${connections.map(c => `
                            <div class="text-xs text-gray-300">${c.topic} (${c.count} shared)</div>
                        `).join('')}
                    </div>
                ` : ''}
                <div class="text-xs text-gray-500 mt-2">Click to view documents</div>
            `;
            
            tooltip.classList.remove('hidden');
            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.add('hidden');
        }

        function zoomIn() {
            svg.transition().duration(300).call(zoom.scaleBy, 1.5);
        }

        function zoomOut() {
            svg.transition().duration(300).call(zoom.scaleBy, 0.67);
        }

        function resetZoom() {
            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
        }
        
        function fitToScreen() {
            if (!nodes.length) return;
            
            // Calculate bounds of all nodes
            const padding = 50;
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            nodes.forEach(n => {
                if (n.x < minX) minX = n.x;
                if (n.x > maxX) maxX = n.x;
                if (n.y < minY) minY = n.y;
                if (n.y > maxY) maxY = n.y;
            });
            
            const width = window.innerWidth;
            const height = window.innerHeight - 60;
            const graphWidth = maxX - minX + padding * 2;
            const graphHeight = maxY - minY + padding * 2;
            
            const scale = Math.min(width / graphWidth, height / graphHeight, 2);
            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;
            
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
                    .translate(width / 2, height / 2)
                    .scale(scale)
                    .translate(-centerX, -centerY)
            );
        }
        
        function searchNodes(query) {
            const q = query.toLowerCase().trim();
            
            // Reset all highlights
            d3.selectAll('.node').classed('highlighted', false);
            d3.selectAll('.link').classed('highlighted', false);
            
            if (!q) return;
            
            // Find matching nodes
            const matchingNodes = nodes.filter(n => n.label.toLowerCase().includes(q));
            
            if (matchingNodes.length === 0) return;
            
            // Highlight matching nodes
            d3.selectAll('.node')
                .classed('highlighted', d => d.label.toLowerCase().includes(q));
            
            // Highlight connected links
            const matchingIds = new Set(matchingNodes.map(n => n.id));
            d3.selectAll('.link')
                .classed('highlighted', d => matchingIds.has(d.source.id) || matchingIds.has(d.target.id));
            
            // If only one match, zoom to it
            if (matchingNodes.length === 1) {
                const node = matchingNodes[0];
                const width = window.innerWidth;
                const height = window.innerHeight - 60;
                svg.transition().duration(750).call(
                    zoom.transform,
                    d3.zoomIdentity.translate(width/2, height/2).scale(2).translate(-node.x, -node.y)
                );
            }
        }
        
        // Search input handler
        document.getElementById('searchNode').addEventListener('input', (e) => {
            searchNodes(e.target.value);
        });

        // Handle resize
        window.addEventListener('resize', () => {
            const width = window.innerWidth;
            const height = window.innerHeight - 60;
            svg.attr('width', width).attr('height', height);
            simulation.force('center', d3.forceCenter(width / 2, height / 2));
            simulation.alpha(0.3).restart();
        });

        init();
    </script>
</body>
</html>
